var d=Object.defineProperty;var u=(e,t,a)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var c=(e,t,a)=>u(e,typeof t!="symbol"?t+"":t,a);import{S as o}from"./storage.js";const r="zen-timer-tick";class l{constructor(){c(this,"state");c(this,"settings",null);this.state={isRunning:!1,mode:"focus",remainingSeconds:25*60,activeTaskId:null,lastTick:Date.now(),cyclesCompleted:0}}async init(){this.settings=await o.getSettings();const t=await o.getTimerState();if(t&&(this.state=t,this.state.isRunning)){const a=Date.now(),s=Math.floor((a-this.state.lastTick)/1e3);s>0&&await this.tick(s)}}async start(t){this.settings||await this.init(),t&&(this.state.activeTaskId=t),this.state.isRunning||this.broadcastSound("start"),this.state.isRunning=!0,this.state.lastTick=Date.now(),await this.updateActiveTaskStatus(!0),await this.saveState(),await this.createAlarm(),this.broadcastState()}async pause(){this.state.isRunning=!1,await this.updateActiveTaskStatus(!1),await this.saveState(),await this.clearAlarm(),this.broadcastState()}async reset(){this.settings||await this.init(),this.state.isRunning=!1,this.state.mode="focus",this.state.remainingSeconds=this.getDurationForMode("focus"),this.state.cyclesCompleted=0,await this.updateActiveTaskStatus(!1),await this.saveState(),await this.clearAlarm(),this.broadcastState()}async skip(){await this.switchMode()}getDurationForMode(t){var a,s,i;switch(t){case"focus":return(((a=this.settings)==null?void 0:a.focusDuration)||25)*60;case"break":return(((s=this.settings)==null?void 0:s.breakDuration)||5)*60;case"longBreak":return(((i=this.settings)==null?void 0:i.longBreakDuration)||15)*60}}async tick(t=1){if(!this.state.isRunning)return;const a=Date.now();this.state.lastTick=a,this.state.remainingSeconds-=t,this.state.mode==="focus"&&this.state.activeTaskId&&await this.updateTaskTime(this.state.activeTaskId,t*1e3),this.state.remainingSeconds<=0?(this.state.remainingSeconds=0,await this.handleTimerComplete()):(await this.saveState(),this.broadcastState(),this.updateBadge())}async handleTimerComplete(){var t;if(this.state.mode==="focus"){this.state.cyclesCompleted++,this.state.activeTaskId&&await this.incrementTaskPomodoros(this.state.activeTaskId);const a=((t=this.settings)==null?void 0:t.cyclesBeforeLongBreak)||4,s=this.state.cyclesCompleted%a===0;this.state.mode=s?"longBreak":"break",this.broadcastSound("break")}else this.state.mode="focus",this.broadcastSound("resume");this.state.remainingSeconds=this.getDurationForMode(this.state.mode),this.state.lastTick=Date.now(),this.state.isRunning=!0,await this.saveState(),this.broadcastState(),this.updateBadge(),this.sendNotification()}async switchMode(){this.state.mode==="focus"?this.state.mode="break":this.state.mode="focus",this.state.remainingSeconds=this.getDurationForMode(this.state.mode),this.state.lastTick=Date.now(),await this.saveState(),this.broadcastState(),this.updateBadge()}async updateActiveTaskStatus(t){this.state.activeTaskId&&console.debug(`Task ${this.state.activeTaskId} active state: ${t}`)}async updateTaskTime(t,a){let s=await o.getTasks();const i=s.findIndex(h=>h.id===t);i!==-1&&(s[i].totalTimeMs=(s[i].totalTimeMs||0)+a,s[i].sessionTimeMs=(s[i].sessionTimeMs||0)+a,await o.saveTasks(s))}async incrementTaskPomodoros(t){let a=await o.getTasks();const s=a.findIndex(i=>i.id===t);s!==-1&&(a[s].pomodorosCompleted=(a[s].pomodorosCompleted||0)+1,await o.saveTasks(a))}async createAlarm(){await chrome.alarms.create(r,{periodInMinutes:1/60})}async clearAlarm(){await chrome.alarms.clear(r)}async saveState(){await o.saveTimerState(this.state)}broadcastState(){chrome.runtime.sendMessage({type:"TIMER_UPDATE",payload:this.state}).catch(()=>{})}broadcastSound(t){chrome.runtime.sendMessage({type:"PLAY_CUE",payload:t}).catch(()=>{})}updateBadge(){const t=Math.ceil(this.state.remainingSeconds/60);chrome.action.setBadgeText({text:t.toString()});const a=this.state.mode==="focus"?"#d4a373":this.state.mode==="break"?"#a3b18a":"#588157";chrome.action.setBadgeBackgroundColor({color:a})}sendNotification(){const t=this.state.mode==="focus"?"Back to focus":"Take a break",a=this.state.mode==="focus"?"Ready to flow?":"Relax and breathe.";chrome.notifications.create({type:"basic",iconUrl:"assets/icon128.png",title:t,message:a,priority:1})}}console.log("Zen Task: Background Service Worker Started");const n=new l;n.init();chrome.alarms.onAlarm.addListener(e=>{e.name==="zen-timer-tick"&&n.tick()});chrome.runtime.onMessage.addListener((e,t,a)=>((async()=>{var s;if(e.type==="START_TIMER")await n.start((s=e.payload)==null?void 0:s.taskId),a({success:!0});else if(e.type==="PAUSE_TIMER")await n.pause(),a({success:!0});else if(e.type==="RESET_TIMER")await n.reset(),a({success:!0});else if(e.type==="SKIP_TIMER")await n.skip(),a({success:!0});else if(e.type==="GET_STATE"){const i=await o.getTimerState();a(i)}})(),!0));
