var d=Object.defineProperty;var u=(a,t,s)=>t in a?d(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;var c=(a,t,s)=>u(a,typeof t!="symbol"?t+"":t,s);import{S as o}from"./storage.js";const r="zen-timer-tick";class m{constructor(){c(this,"state");c(this,"settings",null);this.state={isRunning:!1,mode:"focus",remainingSeconds:25*60,activeTaskId:null,lastTick:Date.now(),cyclesCompleted:0}}async init(){this.settings=await o.getSettings();const t=await o.getTimerState();if(o.onChange(s=>{s.zen_settings&&o.getSettings().then(e=>{this.settings=e,this.state.isRunning||(this.state.remainingSeconds=this.getDurationForMode(this.state.mode),this.saveState(),this.broadcastState(),this.updateBadge())})}),t&&(this.state=t,this.state.isRunning)){const s=Date.now(),e=Math.floor((s-this.state.lastTick)/1e3);e>0&&await this.tick(e)}}async start(t){this.settings||await this.init(),t&&(this.state.activeTaskId=t),this.state.isRunning||this.broadcastSound("start"),this.state.isRunning=!0,this.state.lastTick=Date.now(),await this.updateActiveTaskStatus(!0),await this.saveState(),await this.createAlarm(),this.broadcastState()}async pause(){this.state.isRunning=!1,await this.updateActiveTaskStatus(!1),await this.saveState(),await this.clearAlarm(),this.broadcastState()}async reset(){this.settings||await this.init(),this.state.isRunning=!1,this.state.mode="focus",this.state.remainingSeconds=this.getDurationForMode("focus"),this.state.cyclesCompleted=0,await this.updateActiveTaskStatus(!1),await this.saveState(),await this.clearAlarm(),this.broadcastState()}async skip(){await this.switchMode()}getDurationForMode(t){var s,e,i;switch(t){case"focus":return(((s=this.settings)==null?void 0:s.focusDuration)||25)*60;case"break":return(((e=this.settings)==null?void 0:e.breakDuration)||5)*60;case"longBreak":return(((i=this.settings)==null?void 0:i.longBreakDuration)||15)*60}}async tick(t=1){if(!this.state.isRunning)return;const s=Date.now();this.state.lastTick=s,this.state.remainingSeconds-=t,this.state.mode==="focus"&&this.state.activeTaskId&&await this.updateTaskTime(this.state.activeTaskId,t*1e3),this.state.remainingSeconds<=0?(this.state.remainingSeconds=0,await this.handleTimerComplete()):(await this.saveState(),this.broadcastState(),this.updateBadge())}async handleTimerComplete(){var t;if(this.state.mode==="focus"){this.state.cyclesCompleted++,this.state.activeTaskId&&await this.incrementTaskPomodoros(this.state.activeTaskId);const s=((t=this.settings)==null?void 0:t.cyclesBeforeLongBreak)||4,e=this.state.cyclesCompleted%s===0;this.state.mode=e?"longBreak":"break",this.broadcastSound("break")}else this.state.mode="focus",this.broadcastSound("resume");this.state.remainingSeconds=this.getDurationForMode(this.state.mode),this.state.lastTick=Date.now(),this.state.isRunning=!0,await this.saveState(),this.broadcastState(),this.updateBadge(),this.sendNotification()}async switchMode(){this.state.mode==="focus"?this.state.mode="break":this.state.mode="focus",this.state.remainingSeconds=this.getDurationForMode(this.state.mode),this.state.lastTick=Date.now(),await this.saveState(),this.broadcastState(),this.updateBadge()}async updateActiveTaskStatus(t){this.state.activeTaskId}async updateTaskTime(t,s){let e=await o.getTasks();const i=e.findIndex(h=>h.id===t);i!==-1&&(e[i].totalTimeMs=(e[i].totalTimeMs||0)+s,e[i].sessionTimeMs=(e[i].sessionTimeMs||0)+s,await o.saveTasks(e))}async incrementTaskPomodoros(t){let s=await o.getTasks();const e=s.findIndex(i=>i.id===t);e!==-1&&(s[e].pomodorosCompleted=(s[e].pomodorosCompleted||0)+1,await o.saveTasks(s))}async createAlarm(){await chrome.alarms.create(r,{periodInMinutes:1/60})}async clearAlarm(){await chrome.alarms.clear(r)}async saveState(){await o.saveTimerState(this.state)}broadcastState(){chrome.runtime.sendMessage({type:"TIMER_UPDATE",payload:this.state}).catch(()=>{})}broadcastSound(t){chrome.runtime.sendMessage({type:"PLAY_CUE",payload:t}).catch(()=>{})}updateBadge(){const t=Math.ceil(this.state.remainingSeconds/60);chrome.action.setBadgeText({text:t.toString()});const s=this.state.mode==="focus"?"#d4a373":this.state.mode==="break"?"#a3b18a":"#588157";chrome.action.setBadgeBackgroundColor({color:s})}sendNotification(){const t=this.state.mode==="focus"?"Back to focus":"Take a break",s=this.state.mode==="focus"?"Ready to flow?":"Relax and breathe.";chrome.notifications.create({type:"basic",iconUrl:"assets/icon128.png",title:t,message:s,priority:1})}}console.log("Zen Task: Background Service Worker Started");const n=new m;n.init();chrome.alarms.onAlarm.addListener(a=>{a.name==="zen-timer-tick"&&n.tick()});chrome.runtime.onMessage.addListener((a,t,s)=>((async()=>{var e;if(a.type==="START_TIMER")await n.start((e=a.payload)==null?void 0:e.taskId),s({success:!0});else if(a.type==="PAUSE_TIMER")await n.pause(),s({success:!0});else if(a.type==="RESET_TIMER")await n.reset(),s({success:!0});else if(a.type==="SKIP_TIMER")await n.skip(),s({success:!0});else if(a.type==="GET_STATE"){const i=await o.getTimerState();s(i)}})(),!0));
